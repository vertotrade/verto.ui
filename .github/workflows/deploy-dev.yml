name: Deploys to Dev
on:
  push:
    branches:
      - DEV-467
  repository_dispatch:
    types: [dev]
  workflow_dispatch:
env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: verto-dev-ui-nginx
  ECS_SERVICE: verto-dev-ui-nginx
  ECS_CLUSTER: verto-dev-ui-ecs-fargate
  ECS_TASK_DEFINITION: task-definition.json
  CONTAINER_NAME: nginx
  ASSETS_BUCKET: verto-dev-assets
concurrency: dev

jobs:
  install-and-lint:
    uses: vertotrade/verto.ui/.github/workflows/action-install-lint.yml@DEV-467

  build:
    uses: vertotrade/verto.ui/.github/workflows/action-build.yml@DEV-467
    needs: [install-and-lint]
    with:
      env: dev

  be-build:
    uses: vertotrade/verto.ui/.github/workflows/action-build-backend.yml@DEV-467
    needs: [build]
    with:
      ecr_repo: verto-dev-ui-nginx

  be-publish-dev:
    uses: vertotrade/verto.ui/.github/workflows/action-push-ecr-image.yml@DEV-467
    needs: [be-build]
    with:
      aws_region: us-east-1
      build_number: ${{ github.run_id }}
      ecr_repo: verto-dev-ui-nginx
    secrets:
      aws_access_key_id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}

  be-deploy-dev:
    uses: vertotrade/verto.ui/.github/workflows/action-deploy-ecs.yml@DEV-467
    needs: [be-publish-dev]
    with:
      env: dev
      task_definition: task-definition.json
      aws_region: us-east-1
      ecr_repo: verto-dev-ui-nginx
      service: verto-dev-ui-nginx
      cluster: verto-dev-ui-ecs-fargate
      aws_log_group: /verto/ecs/dev/ui-nginx
      task_role_arn: arn:aws:iam::073696056884:role/rebus-mainnet-ecs-task-role
      task_execution_role_arn: arn:aws:iam::073696056884:role/rebus-mainnet-ecs-task-execution-role
      container_name: nginx
    secrets:
      aws_access_key_id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}

  fe-deploy-dev:
    uses: vertotrade/verto.ui/.github/workflows/action-deploy-s3.yml@DEV-467
    needs: [build]
    with:
      env: dev
      type: main
      aws_region: us-east-1
    secrets:
      aws_access_key_id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
      aws_secret_access_key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
      asset_bucket: verto-dev-assets
