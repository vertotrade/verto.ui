# Builds Backend/Docker workflow
name: Builds Backend
on:
  workflow_call:
    # Required inputs
    inputs:
      ecr_repo:
        required: true
        type: string
  workflow_dispatch:
jobs: 
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        # Checkout code from repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        # Installs and sets up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Restore build from cache
        # Restores the build from cache to speed up build process
        uses: actions/cache@v3
        env:
          cache-name: cache-build-${{ github.run_id }}
        with:
          path: |
            ./node_modules
            ./build
            ./nginx.conf
            ./.htpasswd
          key: build-${{ github.run_id }}
          restore-keys: build-${{ github.run_id }}

      - name: Build
        # Builds the Docker image using specified Dockerfile and tags
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./apps/web/Dockerfile
          # Adds "latest" tag
          tags: ${{ inputs.ecr_repo }}:latest
          outputs: type=docker,dest=/tmp/${{ inputs.ecr_repo }}.tar

      - name: Create a upload-docker-build
        # Creates a folder to upload to artifact
        shell: bash
        run: |
          cp -r /tmp/${{ inputs.ecr_repo }}.tar upload-docker-build

      #  Uploads the upload-build to artifact
      - name: Upload build
        uses: actions/upload-artifact@v3
        with:
          name: docker-build
          path: upload-docker-build
